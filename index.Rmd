---
title: "BESTMPA"
author: "Remi Daigle"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

Basic description of BESTMPA...

## Housekeeping
Before getting started, using the housekeeping function will prepare the environment and your file structure for modelling. This function will conveniently create a results folder, clear the environment, figures, delete previous results, and increase the memory limit if desired.

```{r}
require(BESTMPA)
results_folder <- "D:/BESTMPA_results"
housekeeping(results_folder=results_folder,env=TRUE,fig=TRUE,delete=TRUE,memorylimit=memory.limit())
```

## Spatial Baselayer
## Exclusive Economic Zone
```{r, message=FALSE, warning=FALSE, result='hide'}
require(rgdal)
EEZ <- readOGR(dsn=paste0(getwd(),"/shapefiles"),layer="eez_iho_union_v2")
plot(EEZ, col='blue')
```

Remove Canadian part of the Davis Strait for EEZ since it's beyond cod's normal habitat
```{r}
plot(EEZ, col='blue')
EEZ <- EEZ[EEZ$marregion!="Canadian part of the Davis Strait",]
plot(EEZ, col='red',add=T)
```

## Load cod habitat and breeding sites
Shapefile generated by georeferencing figure 2 from Lough 2004
```{r}
Habitats <- readOGR(dsn=paste0(getwd(),"/shapefiles"),layer="cod_habitat")
plot(Habitats,col='green')
Breeding <- readOGR(dsn=paste0(getwd(),"/shapefiles"),layer="cod_breeding")[2:15,] # remove first Breeding zone, outside EEZ
plot(Breeding,col='yellow',add=T)

```

## Establish basic grid
Define `cell_size` in m, minimum size of MPA's in number of `cells`, default projection and which areas to include in the grid's dataframe
```{r}
# cell size in m
cell_size <- 20000
# minimum size of MPA
cells=3
# default projection
proj  <- "+proj=utm +zone=20 +datum=NAD83 +units=m +no_defs +ellps=GRS80 +towgs84=0,0,0"
# create grid
p <- initgrid(EEZ,cell_size,proj,areas=c(Habitats=Habitats,Breeding=Breeding))

plot(p)
plot(p[p$Habitats==1,],col='green',add=T)
plot(p[p$Breeding==1,],col='yellow',add=T)

```

```{r, eval=FALSE, include=FALSE}
#### set status-quo scenario ####
p <- addscenario(domain=p,included=oldMPA,replicates=replicates,name="Status_quo",cells=cells)

#### set maximum distance ####
p <- addscenario(domain=p,included=oldMPA,MPA_coverage=MPA_coverage,replicates=replicates,name="MPA_MD",cell_size=cell_size,cells=cells)

#### set fixed distance ####
p <- addscenario(domain=p,included=oldMPA,MPA_coverage=MPA_coverage,replicates=replicates,dist=75000,name="MPA_FX",cell_size=cell_size,cells=cells)

#### set targeted scenario ####
p <- addscenario(domain=p,included=oldMPA,priority=p$Habitats,excluded=p$Breeding,MPA_coverage=MPA_coverage,replicates=replicates,dist=75000,name="MPA_TR",cell_size,cells=cells)


writeOGR(p,dsn="shapefiles",layer="master_polygon",driver="ESRI Shapefile",overwrite_layer = TRUE)
p <- readOGR(dsn="shapefiles",layer="master_polygon")

plot(p);plot(p[p$MPA_TR_1==1,],col='blue',add=T)

# adjust CCs to be 0 outside habitat
CCs <- CCs*p$Habitats

# load connectivity matrix
#adult
cma <- initcm(p,e_fold_adult,cell_size)
#larvae
cml <- initcm(p,e_fold_larvae,cell_size)

# calculate distances
distance <- gDistance(spTransform(fish_communities,proj),p,byid = T)
breeding_near <- apply(gDistance(spTransform(Breeding,proj),p,byid = T),1,which.min)

# grep("MPA_",names(p))
scenarios <- names(p)[grep("MPA_",names(p))]
scenarios <- scenarios[order(as.numeric(substr(scenarios,8,nchar(scenarios))))]
```

